name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  workflow_dispatch:
    inputs:
      run_npm_ci:
        description: 'Run npm ci?'
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 12m
          script: |
            cd /opt/chainticket
            sudo git fetch origin main
            sudo git reset --hard origin/main
            cd backend
            
            # Solo npm ci si se solicita manualmente
            if [ "${{ github.event.inputs.run_npm_ci }}" = "true" ]; then
              echo "📦 Running npm ci..."
              sudo npm ci --omit=dev
            fi
            
            sudo systemctl restart chainticket
            sleep 2
            curl -s http://localhost:3001/api/health || echo "⚠️ Starting..."
            echo "✅ Done"
